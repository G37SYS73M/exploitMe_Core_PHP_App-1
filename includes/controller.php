<?php

error_reporting(0);

include("db.php");

session_start();

if (isset($_POST['login'])) {
    $uname = $_POST['uname'];
    $pass = $_POST['password'];
    $pass = md5($pass);

    $sql = "SELECT * FROM `users` WHERE uname = '$uname' AND password = '$pass'";
    $res = mysqli_query($conn, $sql);
    if (mysqli_num_rows($res) == 1) {
        $arr = mysqli_fetch_array($res);
        $_SESSION['uid'] = $arr[0];
        $_SESSION['uname'] = $arr[1];
        $_SESSION['writter'] = $arr[3];

        header("Location: ../index.php");
    } else {
        header("Location: ../index.php?invalidLog=1");
    }

}
if (isset($_POST['logout'])) {
    session_unset();
    session_destroy();
    header("Location: ../index.php");
}

if (isset($_POST['publish'])) {

    try{
        $headers = apache_request_headers(); $real_client_ip = $headers["X-Forwarded-For"];
        
        if($real_client_ip !="127.0.0.1"){
            throw new Exception("Error");
            header("Location: ../index.php?invalidLog=2");
        }
        else
        {

            if(isset($_POST['blogTitle']) && isset($_POST['blogBody'])){

                $blogTitle = $_POST['blogTitle'];
                $blogBody = $_POST['blogBody'];

                $sql = "INSERT INTO `blogs`(`b_heading`, `blog_text`) 
                VALUES ('$blogTitle','$blogBody')";
                $res = mysqli_query($conn, $sql);

                if(!$res){
                    header("Location: ../posts.php?eg=1");
                   

                }
                else{

                    $myfile = fopen("blogs/$blogTitle", "w") or die("Unable to open file!");
                    $txt = "BODY: $blogBody";
                    fwrite($myfile, $txt);
                    fclose($myfile);    

                    header("Location: ../posts.php?eg=2");

                }
                
            }

////////

     }
    }
    catch(Exception $e) {
        echo 'Message: ' .$e->getMessage();
        header("Location: ../index.php?invalidLog=2");
      }
}


?>